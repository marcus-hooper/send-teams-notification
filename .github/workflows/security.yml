name: Security

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/*.md'
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/*.md'
  schedule:
    - cron: '0 6 * * 3' # Weekly on Wednesday 6am UTC

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  # Scan dependencies for known vulnerabilities on PRs
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.7.1
        with:
          config-file: .github/dependency-review-config.yml
          fail-on-severity: high
          comment-summary-in-pr: always

  # Static analysis for PowerShell (complements PSScriptAnalyzer in CI)
  script-security:
    name: Script Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Check for hardcoded secrets
        shell: pwsh
        run: |
          $patterns = @(
            'password\s*=\s*[''"][^''"]+[''"]',
            'api[_-]?key\s*=\s*[''"][^''"]+[''"]',
            'secret\s*=\s*[''"][^''"]+[''"]',
            'token\s*=\s*[''"][^''"]+[''"]'
          )

          $issues = @()
          Get-ChildItem -Path ./scripts -Include *.ps1,*.psm1 -Recurse | ForEach-Object {
            $content = Get-Content $_.FullName -Raw
            foreach ($pattern in $patterns) {
              if ($content -match $pattern) {
                $issues += "Potential secret in $($_.Name): matches pattern '$pattern'"
              }
            }
          }

          if ($issues.Count -gt 0) {
            $issues | ForEach-Object { Write-Host "::warning::$_" }
            Write-Host "::error::Found $($issues.Count) potential hardcoded secret(s)"
            exit 1
          }

          Write-Host "No hardcoded secrets detected"

      - name: Check for unsafe patterns
        shell: pwsh
        run: |
          $unsafePatterns = @(
            @{ Pattern = 'Invoke-Expression'; Description = 'Invoke-Expression can execute arbitrary code' },
            @{ Pattern = '\| iex'; Description = 'Piping to iex can execute arbitrary code' },
            @{ Pattern = '-Command\s+\$'; Description = 'Dynamic command execution' }
          )

          $issues = @()
          Get-ChildItem -Path ./scripts -Include *.ps1,*.psm1 -Recurse | ForEach-Object {
            $content = Get-Content $_.FullName -Raw
            foreach ($check in $unsafePatterns) {
              if ($content -match $check.Pattern) {
                $issues += "$($_.Name): $($check.Description)"
              }
            }
          }

          if ($issues.Count -gt 0) {
            $issues | ForEach-Object { Write-Host "::warning::$_" }
            # Warning only - some patterns may be intentional
            Write-Host "Found $($issues.Count) potentially unsafe pattern(s) - review recommended"
          } else {
            Write-Host "No unsafe patterns detected"
          }
