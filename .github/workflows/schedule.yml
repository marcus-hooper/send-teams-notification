name: Scheduled Health Check

on:
  schedule:
    # Run weekly on Monday at 6:00 UTC
    - cron: "0 6 * * 1"
  workflow_dispatch:
    # Allow manual trigger for debugging
    inputs:
      skip_issue_creation:
        description: "Skip creating/updating GitHub issues on failure"
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  health-check:
    name: Module Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read

    env:
      MODULE_PATH: scripts/Send-TeamsNotification.psm1

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            www.powershellgallery.com:443
            psg-prod-eastus.azureedge.net:443

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Validate action.yml
        id: validate-action
        shell: pwsh
        run: |
          $actionFile = Join-Path $PWD 'action.yml'
          if (-not (Test-Path $actionFile)) {
            Write-Error "action.yml not found"
            exit 1
          }
          $content = Get-Content $actionFile -Raw
          if ([string]::IsNullOrWhiteSpace($content)) {
            Write-Error "action.yml is empty"
            exit 1
          }
          Write-Host "action.yml is valid ($($content.Length) characters)"

      - name: Verify module loads
        id: verify-module
        shell: pwsh
        run: |
          $modulePath = Join-Path $PWD $env:MODULE_PATH
          Import-Module $modulePath -Force -ErrorAction Stop
          Write-Host "Module loaded successfully from: $modulePath"

      - name: Verify exported functions
        id: verify-functions
        shell: pwsh
        run: |
          $modulePath = Join-Path $PWD $env:MODULE_PATH
          Import-Module $modulePath -Force

          $expectedFunctions = @(
            'Get-StatusStyling'
            'ConvertTo-CommitFact'
            'Build-FactsArray'
            'Build-AdaptiveCardBody'
            'New-TeamsPayload'
            'Send-TeamsNotification'
          )

          $exportedFunctions = (Get-Module Send-TeamsNotification).ExportedFunctions.Keys

          $missing = $expectedFunctions | Where-Object { $_ -notin $exportedFunctions }
          if ($missing) {
            Write-Error "Missing exported functions: $($missing -join ', ')"
            exit 1
          }

          Write-Host "All expected functions are exported:"
          $expectedFunctions | ForEach-Object { Write-Host "  - $_" }

      - name: Test card generation (dry run)
        id: test-card
        shell: pwsh
        run: |
          $modulePath = Join-Path $PWD $env:MODULE_PATH
          Import-Module $modulePath -Force

          # Test Get-StatusStyling
          $styling = Get-StatusStyling -Status 'success'
          if (-not $styling.AccentColor -or -not $styling.Style -or -not $styling.Emoji) {
            Write-Error "Get-StatusStyling returned incomplete data"
            exit 1
          }
          Write-Host "Get-StatusStyling: OK"

          # Test Build-FactsArray
          $facts = Build-FactsArray -Repository 'owner/repo' -Actor 'testuser' -Environment 'production'
          if ($facts.Count -lt 2) {
            Write-Error "Build-FactsArray returned insufficient facts"
            exit 1
          }
          Write-Host "Build-FactsArray: OK"

          # Test Build-AdaptiveCardBody
          $cardBody = Build-AdaptiveCardBody `
            -Title 'Test Deployment' `
            -Status 'success' `
            -Styling $styling `
            -Facts $facts `
            -RunUrl 'https://github.com/owner/repo/actions/runs/123'

          if ($cardBody.Count -lt 3) {
            Write-Error "Build-AdaptiveCardBody returned insufficient elements"
            exit 1
          }
          Write-Host "Build-AdaptiveCardBody: OK"

          # Test New-TeamsPayload
          $payload = New-TeamsPayload -CardBody $cardBody
          if (-not $payload.type -or -not $payload.attachments) {
            Write-Error "New-TeamsPayload returned incomplete payload"
            exit 1
          }
          Write-Host "New-TeamsPayload: OK"

      - name: Validate JSON structure
        id: validate-json
        shell: pwsh
        run: |
          $modulePath = Join-Path $PWD $env:MODULE_PATH
          Import-Module $modulePath -Force

          $styling = Get-StatusStyling -Status 'failure'
          $facts = Build-FactsArray -Repository 'test/repo' -Actor 'user'
          $commitFacts = @(
            @{ title = 'abc1234'; value = 'Test commit message' }
          )

          $cardBody = Build-AdaptiveCardBody `
            -Title 'GitHub Deployment' `
            -Status 'failure' `
            -Styling $styling `
            -Facts $facts `
            -CommitFacts $commitFacts `
            -RunUrl 'https://github.com/test/repo/actions/runs/456'

          $payload = New-TeamsPayload -CardBody $cardBody
          $json = $payload | ConvertTo-Json -Depth 30

          # Verify JSON is valid
          $parsed = $json | ConvertFrom-Json
          if (-not $parsed) {
            Write-Error "Generated JSON is invalid"
            exit 1
          }

          # Verify Adaptive Card structure
          $card = $parsed.attachments[0].content
          if ($card.type -ne 'AdaptiveCard') {
            Write-Error "Invalid card type: $($card.type)"
            exit 1
          }
          if ($card.version -ne '1.5') {
            Write-Error "Invalid card version: $($card.version)"
            exit 1
          }

          Write-Host "JSON structure is valid"
          Write-Host "Payload size: $($json.Length) characters"

      - name: Run PSScriptAnalyzer
        id: lint
        timeout-minutes: 2
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $results = Invoke-ScriptAnalyzer -Path ./scripts -Recurse -Settings PSGallery
          $results | Format-Table -AutoSize
          if ($results) {
            Write-Error "PSScriptAnalyzer found $($results.Count) issue(s)"
            exit 1
          }
          Write-Host "No issues found"

      - name: Run Pester tests
        id: test
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = './tests'
          $config.Output.Verbosity = 'Detailed'
          $config.Run.Exit = $true
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = 'test-results.xml'
          $config.TestResult.OutputFormat = 'NUnitXml'
          Invoke-Pester -Configuration $config

      - name: Write workflow summary
        if: always()
        shell: pwsh
        run: |
          $summary = @"
          ## Health Check Results

          | Check | Status |
          |-------|--------|
          | action.yml validation | ${{ steps.validate-action.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |
          | Module loading | ${{ steps.verify-module.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |
          | Exported functions | ${{ steps.verify-functions.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |
          | Card generation | ${{ steps.test-card.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |
          | JSON structure | ${{ steps.validate-json.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |
          | PSScriptAnalyzer | ${{ steps.lint.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |
          | Pester tests | ${{ steps.test.outcome == 'success' && '✅ Passed' || '❌ Failed' }} |

          **Workflow run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          "@
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

      - name: Upload test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: health-check-test-results
          path: test-results.xml
          if-no-files-found: ignore
          retention-days: 14

  # Notify on failure by creating a GitHub issue
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: health-check
    if: failure() && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && !inputs.skip_issue_creation))
    timeout-minutes: 5

    permissions:
      issues: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443

      - name: Ensure status:health-check-failure label exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail
          gh label create "status:health-check-failure" --description "Automated health check detected a failure" --color "d73a4a" --force

      - name: Create failure issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ISSUE_BODY: |
            The scheduled health check workflow failed.

            ## Details
            - **Workflow:** Scheduled Health Check
            - **Run URL:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ## Possible Causes
            - PowerShell Gallery unavailable
            - Module import or export failures
            - PSScriptAnalyzer linting issues
            - Pester test failures
            - Adaptive Card generation errors

            Please investigate and resolve the issue.
        shell: bash
        run: |
          set -euo pipefail
          # Check for existing open issue to avoid duplicates
          EXISTING=$(gh issue list --label "status:health-check-failure" --state open --json number --jq '.[0].number // empty')

          if [[ -n "$EXISTING" ]]; then
            echo "Existing issue #$EXISTING found, adding comment"
            gh issue comment "$EXISTING" --body "Health check failed again on $(date -u '+%Y-%m-%d %H:%M UTC'). [View workflow run]($RUN_URL)"
          else
            echo "Creating new failure issue"
            gh issue create \
              --title "Scheduled health check failed" \
              --label "status:health-check-failure,type:bug" \
              --body "$ISSUE_BODY"
          fi

  # Auto-close failure issues when health check passes
  notify-success:
    name: Close Stale Failure Issues
    runs-on: ubuntu-latest
    needs: health-check
    if: success() && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && !inputs.skip_issue_creation))
    timeout-minutes: 5

    permissions:
      issues: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443

      - name: Close stale failure issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail
          issues=$(gh issue list --label "status:health-check-failure" --state open --json number --jq '.[].number' || true)
          if [[ -n "$issues" ]]; then
            while read -r issue; do
              echo "Closing issue #$issue"
              gh issue close "$issue" --comment "Health check is passing again as of $(date -u '+%Y-%m-%d %H:%M UTC'). Closing automatically."
            done <<< "$issues"
          fi
          echo "Done processing stale failure issues"
