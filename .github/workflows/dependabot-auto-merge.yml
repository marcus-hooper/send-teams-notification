name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  auto-merge:
    name: Auto-merge safe updates
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.actor == 'dependabot[bot]'

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443

      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@21025c705c08248db411dc16f3619e6b5f9ea21a # v2.5.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge patch and minor updates
        if: |
          steps.metadata.outputs.package-ecosystem != 'github_actions' &&
          (steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
           steps.metadata.outputs.update-type == 'version-update:semver-minor')
        run: |
          echo "Auto-merging ${{ steps.metadata.outputs.update-type }} update"
          echo "Package: ${{ steps.metadata.outputs.dependency-names }}"
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip auto-merge for GitHub Actions updates
        if: steps.metadata.outputs.package-ecosystem == 'github_actions'
        run: |
          echo "GitHub Actions updates require manual merge (GITHUB_TOKEN cannot modify workflow files)"
          echo "Please review and merge PR #${{ github.event.pull_request.number }} manually"

      - name: Add label for major updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          echo "Major update detected - requires manual review"
          # Create labels if they don't exist (ignore errors if they already exist)
          gh label create "major-update" --description "Major version update requiring manual review" --color "d73a4a" 2>/dev/null || true
          gh label create "needs-review" --description "PR needs manual review before merging" --color "fbca04" 2>/dev/null || true
          gh pr edit "$PR_URL" --add-label "major-update,needs-review"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}

      - name: Comment on major updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment "$PR_URL" --body "**Major version update detected**

          This PR updates **${{ steps.metadata.outputs.dependency-names }}** to a new major version.

          **Action required:**
          1. Review the changelog for breaking changes
          2. Test thoroughly before merging
          3. Merge manually when ready

          Major updates are not auto-merged for safety."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
