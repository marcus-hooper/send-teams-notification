name: Release

on:
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  update-major-tag:
    name: Update Major Version Tag
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Check for CHANGELOG entry
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
            echo "::error::No CHANGELOG entry found for version $VERSION"
            exit 1
          fi

      - name: Extract version info
        id: version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

          # Validate semver format (v1.0.0 or 1.0.0)
          if [[ ! "$TAG" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Tag '$TAG' does not match semver format (e.g., v1.0.0)"
            exit 1
          fi

          # Extract major version
          MAJOR=$(echo "$TAG" | sed -E 's/^v?([0-9]+).*/v\1/')
          echo "major=$MAJOR" >> "$GITHUB_OUTPUT"
          echo "Extracted major version: $MAJOR from tag: $TAG"

      - name: Update major version tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MAJOR="${{ steps.version.outputs.major }}"
          TAG="${{ steps.version.outputs.tag }}"

          # Delete existing major tag if it exists (ignore errors)
          gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$MAJOR" 2>/dev/null || true

          # Create new major tag pointing to the release commit
          gh api "repos/${{ github.repository }}/git/refs" \
            -f ref="refs/tags/$MAJOR" \
            -f sha="${{ github.sha }}"

          echo "Updated $MAJOR tag to point to $TAG"

      - name: Update release with CHANGELOG notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${TAG#v}"

          # Extract changelog section for this version
          NOTES=$(awk -v ver="$VERSION" '
            $0 ~ "## \\[" ver "\\]" { found=1; next }
            found && /^## \[/ { exit }
            found { print }
          ' CHANGELOG.md)

          # Update release body if we extracted notes
          if [ -n "$NOTES" ]; then
            gh release edit "$TAG" --notes "$NOTES"
            echo "Updated release notes from CHANGELOG.md"
          else
            echo "No changelog content to extract (section may be empty)"
          fi
